<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>ã‚³ãƒãƒ³ãƒ‰ãƒãƒˆãƒ«Ã—ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ï¼ˆv3ï¼‰</title>
<style>
  :root{--bg:#0f1220;--panel:#181c2f;--ink:#e9ecff;--muted:#aab0d6;--accent:#67d4ff;--good:#6ee7a3;--bad:#ff6b7a;--warn:#ffd36e;--btn:#232744;--card:#1e2440}
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",Helvetica,Arial; background:linear-gradient(180deg,#0b0e1a,#0f1220 20%,#0f1220 100%); color:var(--ink)}
  #app{max-width:960px;margin:0 auto;padding:8px 8px 96px;position:relative}
  header#screenTitle{position:sticky;top:0;z-index:10;background:rgba(15,18,32,.8);backdrop-filter:blur(8px);border-bottom:1px solid #2a2f52;padding:12px 8px;text-align:center;font-weight:700}
  .screen{display:none}.screen.active{display:block}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .col{flex:1 1 240px;min-width:240px}
  .panel{background:var(--panel);border:1px solid #2a2f52;border-radius:12px;padding:12px}
  .hint{color:var(--muted);font-size:.92rem}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:10px}
  button,.btn{background:var(--btn);color:var(--ink);border:1px solid #32375d;border-radius:12px;padding:12px 14px;font-size:1rem;font-weight:600;letter-spacing:.03em;cursor:pointer;width:100%;transition:.15s transform,.15s background;touch-action:manipulation}
  button:hover{transform:translateY(-1px)}
  button:disabled{opacity:.5;filter:saturate(.6);cursor:not-allowed}
  .cta{background:linear-gradient(180deg,#2d6bff,#5bb9ff);border:none;color:#fff;text-shadow:0 1px 0 rgba(0,0,0,.2)}
  .danger{background:#4b1730;border-color:#7a1f45}
  .alt{background:#203a32;border-color:#2f6b57}
  .monster{background:var(--card);border:1px solid #2a2f52;border-radius:12px;padding:10px;display:flex;flex-direction:column;gap:6px;position:relative;overflow:hidden}
  .monster .head{display:flex;align-items:center;justify-content:space-between;gap:8px}
  .monster .name{font-weight:800}
  .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;font-weight:700;font-size:.9rem;background:#232744;border:1px solid #394078}
  .statlist{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;font-size:.9rem;color:#d3d8ff}
  .statlist div{background:#1a1f3a;border:1px solid #2a2f52;border-radius:8px;padding:6px 8px;text-align:center}
  .selectMark{position:absolute;right:8px;bottom:8px;background:#16233a;border:1px solid #345b97;color:#9ad0ff;padding:4px 8px;border-radius:8px;font-size:.85rem;font-weight:800}
  .selected{outline:2px solid var(--accent);box-shadow:0 0 0 3px rgba(103,212,255,.25) inset}
  .cpuPick{opacity:.9;border-style:dashed}
  #battleWrap{display:grid;grid-template-rows:auto auto 1fr auto;gap:10px}
  .arena{position:relative;background:#11162a;border:1px solid #2a2f52;border-radius:14px;padding:10px;min-height:220px;display:grid;grid-template-columns:1fr 1fr;gap:10px;align-items:end}
  .side{position:relative;padding:8px}
  .card{background:var(--card);border:1px solid #354075;border-radius:14px;padding:10px;min-height:130px;position:relative;overflow:hidden;transition:.15s transform,.2s box-shadow}
  .card .who{font-size:.95rem;color:var(--muted);margin-bottom:6px}
  .bars{display:grid;gap:6px;margin-top:6px}
  .bar{height:12px;background:#12162a;border:1px solid #2a2f52;border-radius:999px;overflow:hidden}
  .bar .fill{height:100%}
  .bar {position:relative}
  .barNum{position:absolute;right:8px;top:-18px;font-size:.82rem;color:var(--muted);font-weight:700}
  .hp{background:linear-gradient(90deg,#28d07b,#5ce388)}
  .st{background:linear-gradient(90deg,#2db7ff,#67d4ff)}
  .cmds{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
  .cmds .mv{display:flex;flex-direction:column;align-items:flex-start;gap:6px;text-align:left}
  .cmds .mv{display:flex;align-items:center;justify-content:space-between;padding:8px;border-radius:10px}
  .mv > div:first-child{font-weight:800}
  .mv .meta{display:flex;gap:8px;align-items:center;font-size:.9rem;color:#cbd2ff}
  .badge.cost{background:#22314a;border:1px solid #394078;padding:4px 8px;border-radius:8px;font-weight:700}
  .mv .meta .eff{font-weight:900}
  .mv .meta .eff.good{color:var(--good)}
  .mv .meta .eff.bad{color:var(--bad)}
  .swapList{display:flex;gap:8px;flex-wrap:wrap}
  .mini{min-width:120px}
  #battleLog{background:#0e1326;border:1px solid #2a2f52;border-radius:12px;padding:10px;height:180px;overflow:auto;font-family:ui-monospace,Menlo,Consolas,monospace;line-height:1.35}
  #battleLog .logEntry{padding:6px 8px;border-bottom:1px solid rgba(255,255,255,.02);margin-bottom:6px;color:#dfe6ff}
  #battleLog .logEntry .muted{color:var(--muted);font-size:.85rem;margin-left:8px}
  .youGlow{animation:youGlow .35s ease}
  .foeGlow{animation:foeGlow .35s ease}
  .st-zero{animation:stBlink .8s linear infinite}
  @keyframes stBlink{0%{box-shadow:0 0 0 0 rgba(255,107,122,0)}50%{box-shadow:0 0 0 6px rgba(255,107,122,.22)}100%{box-shadow:0 0 0 0 rgba(255,107,122,0)}}
  @keyframes youGlow{from{box-shadow:0 0 0 0 rgba(103,212,255,.0)}to{box-shadow:0 0 0 6px rgba(103,212,255,.2)}}
  @keyframes foeGlow{from{box-shadow:0 0 0 0 rgba(255,107,122,.0)}to{box-shadow:0 0 0 6px rgba(255,107,122,.2)}}
  .shake{animation:shake .25s linear 2}
  @keyframes shake{0%{transform:translateX(0)}25%{transform:translateX(-3px)}50%{transform:translateX(3px)}75%{transform:translateX(-3px)}100%{transform:translateX(0)}}
  #bottomDock{position:fixed;left:0;right:0;bottom:0;z-index:15;padding:8px 8px calc(env(safe-area-inset-bottom) + 8px);background:linear-gradient(180deg,transparent,rgba(8,10,20,.7) 12%,rgba(8,10,20,.95))}
  #explain{max-width:960px;margin:0 auto;background:var(--panel);border:1px solid #2a2f52;border-radius:14px;padding:12px;color:#dfe3ff;font-size:.98rem}
  #dockBtns{max-width:960px;margin:8px auto 0;display:flex;justify-content:center}
  #backBtn{min-width:200px}
  .tap{min-height:48px}.big{min-height:56px;font-size:1.05rem}
  .el-ç‚{--el:#ff6b6b}.el-æ°´{--el:#5bb9ff}.el-é¢¨{--el:#7dd3fc}.el-åœŸ{--el:#c1a374}.el-é›·{--el:#ffd36e}.el-æ°·{--el:#9ad0ff}.el-å…‰{--el:#f5e08a}.el-é—‡{--el:#b28cff}
  .flow{display:flex;gap:8px;flex-wrap:wrap}.flow>*{flex:1}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
  .center{text-align:center}
  table.matrix{width:100%;border-collapse:collapse;font-size:.92rem}
  .matrix th,.matrix td{border:1px solid #2a2f52;padding:6px 8px;text-align:center}
  .matrix th{background:#1a1f3a}
  .mat-good{color:#6ee7a3;font-weight:800}
  .mat-bad{color:#ff6b7a;font-weight:800}
  .mat-even{color:#d3d8ff}
  /* ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« */
  .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:60}
  .modal-overlay.active{display:flex}
  .modal{background:var(--panel);border:1px solid #2a2f52;border-radius:12px;padding:12px;max-width:420px;width:92%;color:var(--ink)}
  .modal .stats{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:8px}
  .modal .stat{background:#0f1424;border:1px solid #24314a;padding:8px;border-radius:8px;text-align:center}
  .modal .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
  .selectBtn{position:absolute;right:8px;top:8px;background:var(--btn);border:1px solid #394078;color:var(--ink);padding:6px 8px;border-radius:8px;font-weight:800;cursor:pointer}
  /* ãƒ›ãƒãƒ¼ã§è¡¨ç¤ºã•ã‚Œã‚‹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆã‚«ãƒ¼ãƒ‰å†…ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼‰ */
  .monster .hoverStats{position:absolute;left:8px;right:8px;bottom:8px;background:rgba(8,10,20,0.75);border:1px solid #2a2f52;padding:8px;border-radius:8px;display:none;z-index:5;color:var(--ink);}
  .monster:hover .hoverStats, .monster.showStats .hoverStats{display:grid}
  .monster .hoverStats{grid-template-columns:repeat(3,1fr);gap:6px;font-size:.85rem}
  .monster .hoverStats .stat{background:#0f1424;border:1px solid #24314a;padding:6px;border-radius:6px;text-align:center}
</style>
</head>
<body>
<div id="app">
  <header id="screenTitle">é–‹å§‹ç”»é¢</header>

  <!-- Start -->
  <section id="screen-start" class="screen active">
    <div class="panel">
      <h2>ã‚ˆã†ã“ãï¼</h2>
      <p class="hint">ã“ã®ã‚²ãƒ¼ãƒ ã¯<strong>ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã‚’é¸ã³ã€æŠ€ã‚’ã‚»ãƒƒãƒˆã—ã¦ãƒãƒˆãƒ«</strong>ã™ã‚‹ãƒ–ãƒ©ã‚¦ã‚¶ã‚²ãƒ¼ãƒ ã§ã™ã€‚çŸ­æ™‚é–“ã§é§†ã‘å¼•ãã®é¢ç™½ã•ã‚’å‘³ã‚ãˆã¾ã™ã€‚</p>
  <div class="flow"><button class="cta big tap" id="goPick" disabled>â–¶ ãƒ‡ãƒ¢ãƒ—ãƒ¬ã‚¤é–‹å§‹</button></div>
    </div>
    <div class="panel">
      <h3>ã‚²ãƒ¼ãƒ ã®ã­ã‚‰ã„</h3>
      <p class="hint">è‚²æˆï¼ˆæŠ€ã‚»ãƒƒãƒˆï¼‰ã§<strong>ã‚¯ãƒªã‚¨ã‚¤ãƒ†ã‚£ãƒ–ã•</strong>ã€å¯¾æˆ¦ã§<strong>èª­ã¿åˆã„</strong>ã‚’æ¥½ã—ã‚ã‚‹ãƒ†ãƒ³ãƒã‚’æ„è­˜ã—ã¦ã„ã¾ã™ã€‚</p>
    </div>
  </section>

  <!-- Pick -->
  <section id="screen-pick" class="screen">
    <div class="panel">
      <div class="row">
        <div class="col">
          <h3>ç›¸æ‰‹ã®å€™è£œï¼ˆãƒ©ãƒ³ãƒ€ãƒ 6ä½“ï¼‰</h3>
          <div id="cpuCandidates" class="grid"></div>
          <div class="flow" style="margin-top:8px"><button id="btnAdvice" class="alt tap">ãŠã™ã™ã‚ã‚’è¦‹ã‚‹</button></div>
          <div id="adviceBox" class="hint" style="margin-top:6px"></div>
        </div>
        <div class="col">
          <h3>ã‚ãªãŸã®é¸å‡ºï¼ˆ<span id="pickCount">0</span>/3ï¼‰</h3>
          <div class="hint">å…¨ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã‹ã‚‰<strong>3ä½“</strong>é¸ã‚“ã§ãã ã•ã„ã€‚æˆ»ã£ã¦ã‚‚é¸æŠã¯ä¿æŒã•ã‚Œã¾ã™ã€‚</div>
          <div id="playerPicks" class="grid"></div>
          <div class="flow" style="margin-top:8px"><button id="toMoveSetup" class="cta big tap" disabled>æŠ€ã‚’é¸ã¶ã¸</button></div>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col">
        <div class="panel">
          <h3>å…¨ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼</h3>
          <div id="allMonsters" class="grid"></div>
        </div>
      </div>
      <div class="col">
        <div class="panel">
          <h3>å±æ€§ç›¸æ€§ãƒãƒˆãƒªã‚¯ã‚¹ï¼ˆæ”»æ’ƒå´â†’é˜²å¾¡å´ï¼‰</h3>
          <div id="matrixWrap"></div>
          <div class="hint">å‡¡ä¾‹ï¼š<span class="mat-good">ã€‡ Ã—1.5</span> ï¼ <span class="mat-even">â–³ Ã—1.0</span> ï¼ <span class="mat-bad">Ã— Ã—0.5</span></div>
        </div>
      </div>
    </div>
  </section>

  <!-- Moves -->
  <section id="screen-moves" class="screen">
    <div class="panel">
      <div id="cpuBar" class="hint" style="margin-bottom:8px"></div>
      <!-- ç›¸æ‰‹å€™è£œã‚«ãƒ¼ãƒ‰è¡¨ç¤ºï¼ˆæŠ€é¸æŠç”»é¢ã§ã‚‚å€™è£œ6ä½“ã‚’ç¢ºèªã§ãã‚‹ï¼‰ -->
      <div id="cpuCandidatesMoves" class="grid" style="margin-bottom:8px"></div>
      <div id="moveSetupArea"></div>
    </div>
  </section>

  <!-- Battle -->
  <section id="screen-battle" class="screen">
    <div id="battleWrap">
      <div class="arena">
        <div class="side" id="youSide">
          <div class="card you">
            <div class="who">ã‚ãªãŸ</div>
            <div class="head row" style="align-items:center">
              <div class="badge" id="youName">â€”</div>
              <div class="badge" id="youEl">â€”</div>
            </div>
            <div class="bars">
              <div class="bar"><div id="youHP" class="fill hp" style="width:100%"></div></div>
              <div class="bar"><div id="youST" class="fill st" style="width:100%"></div></div>
            </div>
          </div>
        </div>
        <div class="side" id="foeSide">
          <div class="card foe">
            <div class="who">ã‚ã„ã¦</div>
            <div class="head row" style="align-items:center">
              <div class="badge" id="foeName">â€”</div>
              <div class="badge" id="foeEl">â€”</div>
            </div>
            <div class="bars">
              <div class="bar"><div id="foeHP" class="fill hp" style="width:100%"></div></div>
            </div>
          </div>
        </div>
        <canvas id="fxCanvas" width="10" height="10" style="position:absolute; inset:0; width:100%; height:100%; pointer-events:none;"></canvas>
      </div>

      <div class="panel">
        <div class="row">
          <div class="col">
            <h3>ã‚³ãƒãƒ³ãƒ‰</h3>
            <div id="cmdArea" class="cmds"></div>
            <div class="flow" style="margin-top:8px">
              <button id="openSwap" class="alt tap">ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼äº¤ä»£</button>
              <button id="giveUp" class="danger tap">é™å‚</button>
            </div>
          </div>
          <div class="col">
            <h3>äº¤ä»£å€™è£œ</h3>
            <div id="swapArea" class="swapList"></div>
          </div>
        </div>
      </div>

      <div id="battleLog" class="mono panel"></div>

      <div id="battleResult" class="panel" style="display:none">
        <h3 id="resultText" class="center">â€”</h3>
        <div class="panel"><div class="center" style="white-space:pre-line">
ãƒ—ãƒ¬ã‚¤ã—ã¦ã„ãŸã ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸï¼
ãœã²æ„Ÿæƒ³ã‚„æ”¹å–„ç‚¹ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚
ã“ã®ã‚²ãƒ¼ãƒ ã‚’ã‚ˆã‚Šé¢ç™½ãã™ã‚‹ãŸã‚ã®ã”æ„è¦‹ã‚’ãŠå¾…ã¡ã—ã¦ã„ã¾ã™ã€‚
        </div></div>
        <div class="flow" style="margin-top:8px"><button id="restart" class="cta big tap">ãƒªã‚¹ã‚¿ãƒ¼ãƒˆ</button></div>
      </div>
    </div>
  </section>
</div>

<div id="bottomDock">
  <div id="explain">ã“ã®ã‚²ãƒ¼ãƒ ã¯ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã‚’é¸ã³ã€æŠ€ã‚’ã‚»ãƒƒãƒˆã—ã¦ãƒãƒˆãƒ«ã™ã‚‹ãƒ–ãƒ©ã‚¦ã‚¶ã‚²ãƒ¼ãƒ ã§ã™ã€‚</div>
  <div id="dockBtns"><button id="backBtn" class="tap big">â—€ æˆ»ã‚‹</button></div>
</div>

<!-- ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="monsterModal" class="modal-overlay" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <h3 id="modalName">â€”</h3>
    <div id="modalEl" class="hint">â€”</div>
    <div class="stats" id="modalStats">
      <!-- stat boxes inserted here -->
    </div>
    <div class="actions">
      <button id="modalClose" class="btn">é–‰ã˜ã‚‹</button>
    </div>
  </div>
</div>

<script>
function showMonsterModal(m){ const mod = document.getElementById('monsterModal'); document.getElementById('modalName').textContent = m.name; document.getElementById('modalEl').textContent = EL_ICON[m.el]+' '+m.el; const stats = document.getElementById('modalStats'); stats.innerHTML=''; ['hp','st','atk','def','mag','spd'].forEach(k=>{ const d = document.createElement('div'); d.className='stat'; d.textContent = k.toUpperCase() + ': ' + (m[k] ?? 'â€”'); stats.appendChild(d); }); mod.classList.add('active'); mod.setAttribute('aria-hidden','false'); }
function hideMonsterModal(){ const mod = document.getElementById('monsterModal'); mod.classList.remove('active'); mod.setAttribute('aria-hidden','true'); }
document.getElementById('modalClose').addEventListener('click', hideMonsterModal);
document.getElementById('monsterModal').addEventListener('click', (e)=>{ if(e.target.id==='monsterModal') hideMonsterModal(); });
</script>
<!-- ãƒ‡ãƒ¢ç”¨ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ï¼ˆå›³é‘‘ç”¨ã® render-*.js ã¯ pages/* ãŒä½¿ç”¨ï¼‰ -->
<script src="assets/js/monsters.js" defer></script>
<script src="assets/js/moves.js" defer></script>

<script>
/* ===== ãƒ‡ãƒ¼ã‚¿ ===== */
const ELEMENTS=['ç‚','æ°´','é¢¨','åœŸ','é›·','æ°·','å…‰','é—‡'];
const EL_ICON={ç‚:'ğŸ”¥',æ°´:'ğŸ’§',é¢¨:'ğŸŒªï¸',åœŸ:'â›°ï¸',é›·:'âš¡',æ°·:'â„ï¸',å…‰:'âœ¨',é—‡:'ğŸŒ‘'};
const EL_COLOR={ç‚:'#ff6b6b',æ°´:'#5bb9ff',é¢¨:'#7dd3fc',åœŸ:'#c1a374',é›·:'#ffd36e',æ°·:'#9ad0ff',å…‰:'#f5e08a',é—‡:'#b28cff'};
const TYPE_EFFECT={
  ç‚:{æ°·:1.5,æ°´:0.5,åœŸ:0.5}, æ°´:{ç‚:1.5,åœŸ:1.5,é›·:0.5}, é¢¨:{åœŸ:1.5,æ°·:0.5},
  åœŸ:{é›·:1.5,é¢¨:0.5,æ°´:0.5}, é›·:{æ°´:1.5,åœŸ:0.5}, æ°·:{é¢¨:1.5,ç‚:0.5}, å…‰:{é—‡:1.5}, é—‡:{å…‰:1.5}
};
// ãƒ‡ãƒ¼ã‚¿ã¯å¤–éƒ¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆassets/js/monsters.js / assets/js/moves.jsï¼‰ã§èª­ã¿è¾¼ã¾ã‚Œã¾ã™
let MONSTERS = window.MONSTERS || [];
let MOVES = window.MOVES || [];
function _tryInitFromGlobals(){ if(window.MONSTERS) MONSTERS = window.MONSTERS; if(window.MOVES) MOVES = window.MOVES; if(MONSTERS.length && MOVES.length){ try{ // ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–ã—ã¦ãƒ‡ãƒ¼ã‚¿æº–å‚™å®Œäº†ã‚’çŸ¥ã‚‰ã›ã‚‹
        const go = document.getElementById('goPick'); if(go) go.disabled = false;
      }catch(e){} } }
window.addEventListener('monsters:loaded', ()=>{ MONSTERS = window.MONSTERS || []; _tryInitFromGlobals(); }, {once:true});
window.addEventListener('moves:loaded', ()=>{ MOVES = window.MOVES || []; _tryInitFromGlobals(); }, {once:true});
// å³æ™‚ãƒã‚§ãƒƒã‚¯ï¼ˆå¤–éƒ¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒæ—¢ã«å®Ÿè¡Œæ¸ˆã¿ã®å ´åˆï¼‰
_tryInitFromGlobals();

/* ===== çŠ¶æ…‹ ===== */
const App={ screen:'start', cpuCandidates:[], cpuTeam:[], playerPick:[], playerLoadouts:{}, moveSetupIndex:0, battle:null };

/* ===== DOMãƒ˜ãƒ«ãƒ‘ ===== */
const $=sel=>document.querySelector(sel);
const el=(tag,attrs={},...kids)=>{ const n=document.createElement(tag); for(const [k,v] of Object.entries(attrs)){ if(k==='class') n.className=v; else if(k==='style') n.setAttribute('style',v); else if(k.startsWith('on')) n.addEventListener(k.slice(2).toLowerCase(),v); else if(typeof v==='boolean'){ n[k]=v; if(!v) n.removeAttribute(k);} else n.setAttribute(k,v);} for(const k of kids) n.append(k); return n; };

/* ===== ç”»é¢åˆ¶å¾¡ ===== */
function setScreen(name){
  App.screen=name;
  $('#screenTitle').textContent= name==='start'?'é–‹å§‹ç”»é¢': name==='pick'?'ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼é¸æŠç”»é¢': name==='moves'?'æŠ€é¸æŠç”»é¢': name==='battle'?'ãƒãƒˆãƒ«ç”»é¢':'';
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  $('#screen-'+name).classList.add('active');
  $('#explain').textContent = name==='start'?'ã“ã®ã‚²ãƒ¼ãƒ ã¯ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã‚’é¸ã³ã€æŠ€ã‚’ã‚»ãƒƒãƒˆã—ã¦ãƒãƒˆãƒ«ã™ã‚‹ãƒ–ãƒ©ã‚¦ã‚¶ã‚²ãƒ¼ãƒ ã§ã™ã€‚': name==='pick'?'ç›¸æ‰‹ã¯6ä½“ã®å€™è£œã‹ã‚‰3ä½“ã‚’é¸ã³ã¾ã™ã€‚ç›¸æ€§ã‚’è¦‹ã¦è‡ªåˆ†ã®3ä½“ã‚’é¸ã³ã¾ã—ã‚‡ã†ã€‚': name==='moves'?'å„ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã«æŠ€ã‚’4ã¤ã‚»ãƒƒãƒˆã—ã¦ãã ã•ã„ã€‚é¸æŠæ¸ˆã¿ã¯ä¸Šã®ãƒªã‚¹ãƒˆã‹ã‚‰è§£é™¤ã§ãã¾ã™ã€‚': 'æŠ€ã‚’é¸ã¶ï¼äº¤ä»£ã™ã‚‹ã‚’é§†ä½¿ã—ã¦å‹åˆ©ã‚’ç›®æŒ‡ã—ã¾ã—ã‚‡ã†ã€‚';
  $('#backBtn').style.display=(name==='start')?'none':'inline-flex';
}

/* ===== é–‹å§‹ ===== */
$('#goPick').addEventListener('click',()=>{ if(!App.cpuCandidates.length) App.cpuCandidates = pickRandomDistinct(MONSTERS.map(m=>m.id),6); renderPickScreen(); setScreen('pick'); });
$('#backBtn').addEventListener('click',()=>{ if(App.screen==='pick') setScreen('start'); else if(App.screen==='moves') setScreen('pick'); else if(App.screen==='battle'){ App.battle=null; setScreen('moves'); }});

/* ===== ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼é¸æŠ ===== */
function renderPickScreen(){
  const cpuWrap=$('#cpuCandidates'); cpuWrap.innerHTML='';
  for(const id of App.cpuCandidates){ cpuWrap.append(monsterCard(byId(MONSTERS,id),{cpu:true})); }
  $('#btnAdvice').onclick=()=>{ $('#adviceBox').innerHTML=buildAdvice(); };
  const all=$('#allMonsters'); all.innerHTML='';
  for(const m of MONSTERS){ all.append(monsterCard(m,{selectable:true, selected:App.playerPick.includes(m.id)})); }
  const picks=$('#playerPicks'); picks.innerHTML=''; App.playerPick.forEach(id=>picks.append(monsterCard(byId(MONSTERS,id),{mini:true})));
  $('#pickCount').textContent=App.playerPick.length;
  $('#toMoveSetup').disabled=(App.playerPick.length!==3);
  $('#matrixWrap').innerHTML=buildMatrix();
}
function monsterCard(m,opt={}){
  const card=el('div',{class:'monster compact '+(opt.mini?'mini':'' )+' el-'+m.el, title:m.name});
  const nameWrap = el('div',{class:'head'}, el('div',{class:'name'},m.name));
  const badge = el('div',{class:'badge'}, EL_ICON[m.el]+' '+m.el);
  nameWrap.append(badge);
  // hover/tap ã§è©³ç´°ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’è¡¨ç¤ºã™ã‚‹ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤
  const hoverStats = el('div',{class:'hoverStats'});
  ['hp','st','atk','def','mag','spd'].forEach(k=>{ hoverStats.append(el('div',{class:'stat'}, (k.toUpperCase()) + ': ' + (m[k] ?? 'â€”'))); });
  card.append(nameWrap, hoverStats);
  if(opt.cpu){ card.classList.add('cpuPick'); }
  if(opt.selected){ card.classList.add('selected'); }
  if(opt.selectable){ card.style.cursor='pointer'; card.addEventListener('click',()=>{ const i=App.playerPick.indexOf(m.id); if(i>=0) App.playerPick.splice(i,1); else { if(App.playerPick.length>=3) return; App.playerPick.push(m.id);} renderPickScreen(); });
    // ã‚¿ãƒƒãƒãƒ‡ãƒã‚¤ã‚¹å‘ã‘: ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºã‚’ãƒˆã‚°ãƒ«
    nameWrap.addEventListener('click',(e)=>{ e.stopPropagation(); // toggle only the card
      card.classList.toggle('showStats');
    });
  }
  return card;
}
$('#toMoveSetup').addEventListener('click',()=>{ if(!App.playerPick.length) return; App.moveSetupIndex=0; renderMoveSetup(); setScreen('moves'); });

function buildMatrix(){ const tbl=document.createElement('table'); tbl.className='matrix mono'; const thead=document.createElement('thead'); const trh=document.createElement('tr'); trh.append(document.createElement('th')); ELEMENTS.forEach(d=>{ const th=document.createElement('th'); th.textContent=d; trh.append(th); }); thead.append(trh); tbl.append(thead); const tb=document.createElement('tbody'); ELEMENTS.forEach(att=>{ const tr=document.createElement('tr'); const th=document.createElement('th'); th.textContent=att; tr.append(th); ELEMENTS.forEach(def=>{ const td=document.createElement('td'); const eff=TYPE_EFFECT[att]?.[def]??1.0; if(eff>1){ td.textContent='ã€‡'; td.className='mat-good'; } else if(eff<1){ td.textContent='Ã—'; td.className='mat-bad'; } else { td.textContent='â–³'; td.className='mat-even'; } tr.append(td); }); tb.append(tr); }); tbl.append(tb); return tbl.outerHTML; }
function buildAdvice(){ if(!App.cpuCandidates.length) return 'å€™è£œãŒæœªç”Ÿæˆã§ã™ã€‚'; const cands=App.cpuCandidates.map(id=>byId(MONSTERS,id)); const freq={}; cands.forEach(m=>{ freq[m.el]=(freq[m.el]||0)+1; }); const counterSet=new Set(); for(const el of Object.keys(freq)){ for(const atk in TYPE_EFFECT){ if((TYPE_EFFECT[atk]?.[el]||1)>1) counterSet.add(atk); } } const counters=[...counterSet]; const recommend=MONSTERS.filter(m=>counters.includes(m.el)).slice(0,3); if(!recommend.length) return 'æœ‰åˆ©å±æ€§ãŒåˆ†æ•£ã€‚ãƒãƒ©ãƒ³ã‚¹é¸å‡ºæ¨å¥¨ã€‚'; const lines=[]; lines.push('å€™è£œã®å±æ€§å‚¾å‘ï¼š '+Object.entries(freq).map(([k,v])=>EL_ICON[k]+k+':'+v).join(' ï¼ ')); lines.push('æœ‰åˆ©ã‚’å–ã‚Šã‚„ã™ã„å±æ€§ï¼š '+counters.map(el=>EL_ICON[el]+el).join(' ')); lines.push('ãŠã™ã™ã‚ï¼š '+recommend.map(m=>`${m.name}ï¼ˆ${EL_ICON[m.el]}${m.el}ï¼‰`).join('ã€ ')); return lines.join('<br>'); }

/* ===== æŠ€é¸æŠ ===== */
function renderMoveSetup(){
  $('#cpuBar').innerHTML='ç›¸æ‰‹ã®å€™è£œï¼š '+App.cpuCandidates.map(id=>{ const m=byId(MONSTERS,id); return `<span class="badge">${EL_ICON[m.el]} ${m.name}</span>`; }).join(' ');
  // Moves ç”»é¢ã§ã‚‚å€™è£œ6ä½“ã‚’ã‚«ãƒ¼ãƒ‰ã§è¡¨ç¤º
  const cpuMovesWrap = $('#cpuCandidatesMoves'); if(cpuMovesWrap){ cpuMovesWrap.innerHTML = ''; App.cpuCandidates.forEach(id=>{ const m = byId(MONSTERS,id); cpuMovesWrap.append(monsterCard(m,{cpu:true})); }); }
  const wrap=$('#moveSetupArea'); wrap.innerHTML='';
  const idx=App.moveSetupIndex; const mId=App.playerPick[idx]; const mon=byId(MONSTERS,mId); let sel=App.playerLoadouts[mId]; if(!sel){ App.playerLoadouts[mId]=[]; sel=App.playerLoadouts[mId]; }
  const root=el('div',{});
  root.append(
    el('div',{class:'panel'},
      el('h3',{},`æŠ€ã‚»ãƒƒãƒˆï¼š${mon.name}ï¼ˆ${idx+1}/3ï¼‰`),
      el('div',{class:'row'},
        el('div',{class:'col'}, monsterCard(mon)),
        el('div',{class:'col'},
          el('div',{class:'hint'}, 'ã¡ã‚‡ã†ã©4ã¤é¸ã‚“ã§ãã ã•ã„ã€‚é¸æŠæ¸ˆã¿ã¯ã‚¿ãƒƒãƒ—ã§è§£é™¤ã§ãã¾ã™ã€‚'),
          el('div',{}, selectedMovesList(sel, mId)),
          el('div',{style:'margin-top:8px'}, moveListForSelect(mon, sel))
        )
      ),
      el('div',{class:'flow',style:'margin-top:8px'},
        el('button',{class:'tap', onClick:()=>{ App.playerLoadouts[mId]=[]; renderMoveSetup(); }},'é¸æŠã‚’ã‚¯ãƒªã‚¢'),
        el('button',{class:'tap', onClick:()=>{ if(idx>0){ App.moveSetupIndex--; renderMoveSetup(); } }},'â—€ å‰ã¸'),
        el('button',{class:'cta big tap', disabled: sel.length<4, onClick:()=>{ // 4ã¤æƒã£ãŸã‚‰æ¬¡ã¸/ãƒãƒˆãƒ«ã¸
          App.playerLoadouts[mId] = sel.slice(0,4);
          if(idx<2){ App.moveSetupIndex = Math.min(2, App.moveSetupIndex + 1); // æ¬¡ã®ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã¸
            renderMoveSetup();
            setScreen('moves');
            return; }
          // idx===2: ãƒãƒˆãƒ«å‰ã«3ä½“ã™ã¹ã¦ãŒ4æŠ€æƒã£ã¦ã„ã‚‹ã‹æ¤œè¨¼
          const incomplete = App.playerPick.find(id => (App.playerLoadouts[id]||[]).length !== 4);
          if(incomplete){
            App.moveSetupIndex = App.playerPick.indexOf(incomplete);
            document.getElementById('explain').textContent = 'å„ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã«æŠ€ã‚’4ã¤ãšã¤ã‚»ãƒƒãƒˆã—ã¦ãã ã•ã„ã€‚æœªå®Œäº†ã®ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ãŒã‚ã‚Šã¾ã™ã€‚';
            renderMoveSetup();
            return;
          }
          // CPUå´ã®é¸å‡ºãŒè¶³ã‚Šãªã„å ´åˆã¯å†ç”Ÿæˆ
          if(App.cpuCandidates.length < 3){ App.cpuCandidates = pickRandomDistinct(MONSTERS.map(m=>m.id), 6); }
          App.cpuTeam = pickRandomDistinct(App.cpuCandidates,3);
          App.cpuLoadouts={}; for(const id of App.cpuTeam){ App.cpuLoadouts[id]=autoPickMoves(byId(MONSTERS,id)); }
          startBattle(); setScreen('battle');
        }}, (idx<2?'æ¬¡ã¸':'ãƒãƒˆãƒ«ã¸'))
      )
    )
  );
  wrap.append(root);
}
function selectedMovesList(sel, mId){ const box=el('div',{class:'grid'}); sel.slice(0,4).forEach(id=>{ const mv=byId(MOVES,id); const btn=el('button',{class:'btn mini tap', onClick:()=>{ const i=App.playerLoadouts[mId].indexOf(mv.id); if(i>=0){ App.playerLoadouts[mId].splice(i,1); renderMoveSetup(); } }}, `âœ• ${mv.name} / ${mv.type} / ${mv.el?EL_ICON[mv.el]+' '+mv.el:'â€”'} / å¨åŠ›${mv.pow} / ST-${mv.cost}`); box.append(btn); }); return box; }
function moveListForSelect(mon, sel){ const list=el('div',{class:'grid'}); MOVES.forEach(mv=>{ const b=el('button',{class:'btn tap'}, el('div',{}, `${mv.name} ${mv.el?('ï½œ'+EL_ICON[mv.el]+' '+mv.el):''}`), el('div',{class:'hint'}, `${mv.type} / å¨åŠ›${mv.pow} / æ¶ˆè²»ST ${mv.cost} ${mv.note?('ï½œ'+mv.note):''}`)); b.disabled = sel.includes(mv.id) || sel.length>=4; b.addEventListener('click',()=>{ App.playerLoadouts[mon.id].push(mv.id); renderMoveSetup(); }); list.append(b); }); return list; }
function autoPickMoves(mon){ const same=MOVES.filter(m=>m.el===mon.el); const phys=same.find(m=>m.type==='ç‰©ç†')||MOVES.find(m=>m.type==='ç‰©ç†'&&!m.el); const mag=same.find(m=>m.type==='é­”æ³•')||MOVES.find(m=>m.type==='é­”æ³•'&&!m.el); const pool=MOVES.filter(m=>m!==phys&&m!==mag&&m.type!=='è£œåŠ©'); const rest=pickRandomDistinct(pool.map(m=>m.id),2); return [phys?.id,mag?.id,...rest].filter(Boolean).slice(0,4); }

/* ===== ãƒãƒˆãƒ« ===== */
function startBattle(){ App.battle={ you:App.playerPick.map(id=>mkFighter(byId(MONSTERS,id),App.playerLoadouts[id]||[])), foe:App.cpuTeam.map(id=>mkFighter(byId(MONSTERS,id),App.cpuLoadouts[id]||[])), iact:0,jact:0, over:false,turn:1,log:[]}; renderBattle(); logLine('ãƒãƒˆãƒ«é–‹å§‹ï¼ ã‚ãªãŸã¯ '+App.battle.you.map(f=>f.name).join(' / ')+'ã€ã‚ã„ã¦ã¯3ä½“ã‚’é¸å‡ºã—ã¦ã„ã¾ã™ã€‚'); }
function mkFighter(m,moveIds){ return {...m,curHP:m.hp,curST:m.st,guard:false,alive:true,moves:moveIds.map(id=>byId(MOVES,id))}; }
function renderBattle(){ const B=App.battle; const Y=B.you[B.iact], F=B.foe[B.jact]; $('#youName').textContent=Y.name; $('#youEl').textContent=EL_ICON[Y.el]+' '+Y.el; $('#foeName').textContent=F.name; $('#foeEl').textContent=EL_ICON[F.el]+' '+F.el; setBar('#youHP',Y.curHP/Y.hp); setBar('#youST',Y.curST/Y.st); setBar('#foeHP',F.curHP/F.hp); // foe ST is kept internal per requirements: hide or de-emphasize
  // ST=0 blink effect on front monsters
  const youCard = $('.you'); const foeCard = $('.foe'); if(Y.curST<=0){ youCard.classList.add('st-zero'); } else { youCard.classList.remove('st-zero'); } if(F.curST<=0){ foeCard.classList.add('st-zero'); } else { foeCard.classList.remove('st-zero'); }
  // numeric labels for bars (attach or update)
  try{
    const youHPBar = $('#youHP').parentElement; const youSTBar = $('#youST').parentElement; const foeHPBar = $('#foeHP').parentElement;
    const ensure=(parent,txt)=>{ let n=parent.querySelector('.barNum'); if(!n){ n=document.createElement('div'); n.className='barNum'; parent.appendChild(n); } n.textContent=txt; };
    ensure(youHPBar, `${Y.curHP}/${Y.hp}`); ensure(youSTBar, `${Y.curST}/${Y.st}`); ensure(foeHPBar, `${F.curHP}/${F.hp}`);
  }catch(e){}
  const cmd=$('#cmdArea'); cmd.innerHTML=''; Y.moves.forEach(mv=>{
    const info=computePreview(Y,F,mv);
    const b=el('button',{class:'mv tap btn el-'+(mv.el||'å…‰')});
    const effMark= info.eff>1.0? el('span',{class:'eff good'},'ã€‡'): info.eff<1.0? el('span',{class:'eff bad'},'Ã—'): el('span',{class:'eff'},'');
    // ST drain preview on target (per-hit * hits)
    const totalTargetStDrain = (info.hits||1) * (info.stPerHit||0);
    const metaParts = [ el('span',{class:'badge'}, `${mv.el?EL_ICON[mv.el]+' '+mv.el:'â€”'}`), el('span',{class:'pow'}, `å¨åŠ› ${mv.pow}${info.mult>1?('â†’'+info.viewPow):''}`), el('span',{class:'badge cost'}, `ST-${mv.cost}`) ];
    if(totalTargetStDrain>0) metaParts.push(el('span',{class:'badge cost'}, `ç›¸æ‰‹ST-${totalTargetStDrain}`));
    b.append(el('div',{},mv.name), el('div',{class:'meta'}, ...metaParts, effMark));
    b.disabled = !Y.alive;
    if(mv.type!=='è£œåŠ©' && Y.curST < mv.cost){ b.title = `ç¾åœ¨STä¸è¶³ï¼ˆå¿…è¦ ${mv.cost}ï¼‰ã€‚ä½¿ç”¨æ™‚ã«æ®‹ã‚ŠSTã‚’æ¶ˆè²»ã—ã€ä¸è¶³åˆ†ã¯è‡ªèº«ã®HPã§è£œå¡«ã—ã¾ã™ã€‚`; }
    else { b.title = totalTargetStDrain>0 ? `ãƒ’ãƒƒãƒˆæ¯ã«ç›¸æ‰‹ST-${info.stPerHit || 0}ï¼ˆåˆè¨ˆ ${totalTargetStDrain}ï¼‰` : ''; }
    b.addEventListener('click',()=>issueTurn({kind:'move',move:mv}));
    cmd.append(b);
  });
  const sp=$('#swapArea'); sp.innerHTML=''; App.battle.you.forEach((f,i)=>{ if(!f.alive||i===App.battle.iact) return; const b=el('button',{class:'btn mini tap'}, `${f.name}ï¼ˆ${EL_ICON[f.el]}ï¼‰`); b.addEventListener('click',()=>issueTurn({kind:'swap',to:i})); sp.append(b); }); $('#openSwap').onclick=()=>{}; $('#giveUp').onclick=()=>issueTurn({kind:'giveup'}); $('#battleLog').innerHTML=App.battle.log.map(l=>'â€¢ '+l).join('<br>'); $('#battleLog').scrollTop=99999; }
function setBar(sel,ratio){ const n=$(sel); const pct=Math.max(0,Math.min(100,Math.round(ratio*100))); n.style.width=pct+'%'; }
function computePreview(att,def,mv){ if(mv.type==='è£œåŠ©') return {eff:1,mult:1,viewPow:0,hits:mv.hits||1,stPerHit:0}; const stab= mv.el&&mv.el===att.el?2.0:1.0; const eff= mv.el?(TYPE_EFFECT[mv.el]?.[def.el]??1.0):1.0; const mult=stab*eff; const viewPow=Math.floor(mv.pow*mult); const hits = mv.hits || 1; const stPerHit = (eff>1?20:10); return {eff,mult,viewPow,hits,stPerHit}; }
async function issueTurn(your){
  if(App.battle.over) return;
  const B=App.battle;
  const Y=B.you[B.iact], F=B.foe[B.jact];
  const actYou=your; const actFoe=decideAI(F,Y);
  const order=decideOrder(Y,F);
  const acts = order==='you-first' ? [{who:'you',act:actYou},{who:'foe',act:actFoe}] : [{who:'foe',act:actFoe},{who:'you',act:actYou}];

  // Process actions sequentially, awaiting animations/processing so logs match visual order
  for(const step of acts){
    if(App.battle.over) break;
    const res = await resolveAction(step.who, step.act);
    if(res==='end') break;
    // update UI between actions so HP/ST bars reflect results before next action
    renderBattle();
  }

  // End-of-turn: Back monsters regenerate ST (1% of max ST, min 1)
  const regen = (m)=>{ const amount = Math.max(1, Math.floor(m.st * 0.01)); m.curST = Math.min(m.st, (m.curST||0) + amount); };
  B.you.forEach((f,i)=>{ if(!f.alive) return; if(i!==B.iact){ regen(f); } });
  B.foe.forEach((f,i)=>{ if(!f.alive) return; if(i!==B.jact){ regen(f); } });
  App.battle.turn++; renderBattle(); checkEnd();
}
function decideOrder(Y,F){ if(Y.spd>F.spd) return 'you-first'; if(F.spd>Y.spd) return 'foe-first'; return Math.random()<.5?'you-first':'foe-first'; }
function resolveAction(who,action){
  return new Promise((resolve)=>{
    const B=App.battle;
    const me=(who==='you')?B.you[B.iact]:B.foe[B.jact];
    const op=(who==='you')?B.foe[B.jact]:B.you[B.iact];
    const meCard=(who==='you')?$('.you'):$('.foe');
    const opCard=(who==='you')?$('.foe'):$('.you');
    if(!me.alive){ resolve(); return; }
    if(action.kind==='giveup'){ logLine((who==='you'?'ã‚ãªãŸ':'ã‚ã„ã¦')+'ã¯é™å‚ã—ãŸï¼'); endBattle(who==='you'?'lose':'win'); resolve('end'); return; }
    if(action.kind==='swap'){ if(action.to!=null){ if(who==='you') B.iact=action.to; else B.jact=action.to; const cur=(who==='you')?B.you[B.iact]:B.foe[B.jact]; logLine((who==='you'?'ã‚ãªãŸ':'ã‚ã„ã¦')+'ã¯ '+cur.name+' ã«äº¤ä»£ã—ãŸï¼'); me.guard=false; (who==='you'?meCard:opCard).classList.add(who==='you'?'youGlow':'foeGlow'); setTimeout(()=> (who==='you'?meCard:opCard).classList.remove(who==='you'?'youGlow':'foeGlow'),350); } resolve(); return; }
    if(action.kind==='move'){
      const mv=action.move;
      if(mv.type==='è£œåŠ©'){
        if(me.curST < mv.cost){ const deficit = mv.cost - me.curST; me.curST = 0; me.curHP = Math.max(0, me.curHP - deficit); logLine((who==='you'?'ã‚ãªãŸ':'ã‚ã„ã¦')+`ã¯STä¸è¶³ã ãŒã€${mv.name}ã€ã‚’ä½¿ç”¨ï¼ˆä¸è¶³åˆ† ${deficit} ã‚’HPã§è£œå¡«ï¼‰`); }
        else { me.curST -= mv.cost; }
        me.guard=true; logLine((who==='you'?'ã‚ãªãŸ':'ã‚ã„ã¦')+'ã¯ã€'+mv.name+'ã€ã§èº«ã‚’å®ˆã£ã¦ã„ã‚‹ï¼'); (who==='you'?meCard:opCard).classList.add('youGlow'); setTimeout(()=> (who==='you'?meCard:opCard).classList.remove('youGlow'),350); resolve(); return;
      }
      if(me.curST < mv.cost){ const deficit = mv.cost - me.curST; me.curST = 0; me.curHP = Math.max(0, me.curHP - deficit); logLine((who==='you'?'ã‚ãªãŸ':'ã‚ã„ã¦')+`ã¯STä¸è¶³ã ãŒã€${mv.name}ã€ã‚’ä½¿ç”¨ï¼ˆä¸è¶³åˆ† ${deficit} ã‚’HPã§è£œå¡«ï¼‰`); }
      else { me.curST -= mv.cost; }
      const hits = mv.hits || 1;
      animateAttack((who==='you')?$('#youSide'):$('#foeSide'), (who==='you')?$('#foeSide'):$('#youSide'), mv.el||'å…‰', ()=>{
        (async ()=>{
          for(let h=1; h<=hits; h++){
            const eff = mv.el?(TYPE_EFFECT[mv.el]?.[op.el]??1.0):1.0;
            const stDrain = 10 * (eff>1?2:1);
            if(op.curST >= stDrain){ op.curST = Math.max(0, op.curST - stDrain); }
            else { const deficit = stDrain - op.curST; op.curST = 0; op.curHP = Math.max(0, op.curHP - deficit); }
            let dealt = calcDamage(me,op,mv);
            if(op.guard){ dealt = Math.floor(dealt*0.5); op.guard=false; }
            op.curHP = Math.max(0, op.curHP - dealt);
            const pv=computePreview(me,op,mv); const effTxt=pv.eff>1.0?'ï¼ˆã“ã†ã‹ã¯ã°ã¤ãã‚“ï¼ï¼‰':(pv.eff<1.0?'ï¼ˆã„ã¾ã²ã¨ã¤â€¦ï¼‰':'');
            logLine((who==='you'?'ã‚ãªãŸ':'ã‚ã„ã¦')+`ã®ã€${mv.name}ã€ï¼ï¼ˆãƒ’ãƒƒãƒˆ ${h}/${hits}ï¼‰ å¨åŠ›${mv.pow}${pv.mult>1?('â†’'+pv.viewPow):''} ${effTxt}`);
            const big = dealt >= Math.max(20, Math.round(op.hp*0.25)); const opCardEl=(who==='you')?$('.foe'):$('.you'); if(big){ opCardEl.classList.add('shake'); setTimeout(()=>opCardEl.classList.remove('shake'),500); }
            if(op.curHP<=0){ op.alive=false; logLine((who==='you'?'ã‚ã„ã¦':'ã‚ãªãŸ')+'ã® '+op.name+' ã¯ ãŸãŠã‚ŒãŸâ€¦'); autoSwapIfPossible(who==='you'?'foe':'you'); break; }
            renderBattle();
            await new Promise(r=>setTimeout(r, 180));
          }
          resolve();
        })();
      });
    }
  });
}
function calcDamage(att,def,mv){ const atk = mv.type==='ç‰©ç†'?att.atk:att.mag; const base=Math.max(1,Math.floor(mv.pow*(10+atk)/(10+def.def))); const stab= mv.el&&mv.el===att.el?2.0:1.0; const eff= mv.el?(TYPE_EFFECT[mv.el]?.[def.el]??1.0):1.0; const rand=0.85+Math.random()*0.15; const dmg=Math.floor(base*stab*eff*rand); return Math.max(1,dmg); }
function autoSwapIfPossible(side){ const B=App.battle; if(side==='you'){ const idx=B.you.findIndex((f,i)=>f.alive&&i!==B.iact); if(idx>=0){ B.iact=idx; logLine('ã‚ãªãŸã¯ '+B.you[idx].name+' ã‚’ãã‚Šã ã—ãŸï¼'); } else endBattle('lose'); } else { const idx=B.foe.findIndex((f,i)=>f.alive&&i!==B.jact); if(idx>=0){ B.jact=idx; logLine('ã‚ã„ã¦ã¯ '+B.foe[idx].name+' ã‚’ãã‚Šã ã—ãŸï¼'); } else endBattle('win'); } }
function decideAI(me,op){ // AI may use moves even if STä¸è¶³ï¼ˆä¸è¶³åˆ†ã¯è‡ªèº«ã®HPã§è£œå¡«ã•ã‚Œã‚‹ï¼‰ã€ãŸã ã—è‡ªæ®ºãƒ©ã‚¤ãƒ³ã®åˆ¤å®šã¯å›é¿ã™ã‚‹
  const usable = me.moves.slice(); let best=null,bestScore=-1;
  for(const mv of usable){ if(mv.type==='è£œåŠ©'){ const need=(me.curST<mv.cost+12)||(typeEff(mv.el,op.el)<1&&op.curHP>op.hp*0.6); const sc=need?5:0; if(sc>bestScore){ bestScore=sc; best={kind:'move',move:mv}; } } else {
      const preview=computePreview(me,op,mv); const atk = mv.type==='ç‰©ç†'?me.atk:me.mag;
      // If using this move would require more ST than current and the deficit >= curHP, deprioritize (would KO self)
      const deficit = Math.max(0, mv.cost - me.curST);
      const killSelfPenalty = deficit >= me.curHP ? 0.01 : 1.0;
      const score = preview.viewPow*(10+atk)/(10+op.def) * killSelfPenalty;
      if(score>bestScore){ bestScore=score; best={kind:'move',move:mv}; }
    } }
  if(!best){ const cand=App.battle.foe.map((f,i)=>({f,i})).filter(x=>x.f.alive&&x.i!==App.battle.jact); const good=cand.find(x=> typeEff(null,op.el,x.f.el)>1.0 ); if(good) return {kind:'swap',to:good.i}; return {kind:'move',move:me.moves[0]}; } return best; }
function typeEff(attEl,defEl,overrideAttEl){ const el=overrideAttEl||attEl; return el?(TYPE_EFFECT[el]?.[defEl]??1.0):1.0; }
function checkEnd(){ if(App.battle?.over) return; const youDead=App.battle.you.every(f=>!f.alive); const foeDead=App.battle.foe.every(f=>!f.alive); if(youDead||foeDead){ endBattle(foeDead?'win':'lose'); } }
function endBattle(result){ App.battle.over=true; $('#battleResult').style.display='block'; $('#resultText').textContent=(result==='win'?'å‹åˆ©ï¼':'æ•—åŒ—â€¦'); }
$('#restart').addEventListener('click',()=>{ App.cpuCandidates=[]; App.cpuTeam=[]; App.playerPick=[]; App.playerLoadouts={}; App.battle=null; $('#battleResult').style.display='none'; renderPickScreen(); setScreen('start'); });

/* ===== æ¼”å‡ºãƒ»ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ===== */
function logLine(t){ App.battle.log.push(t); const wrap = $('#battleLog'); wrap.innerHTML = App.battle.log.map(l=> `<div class="logEntry">â€¢ ${escapeHtml(l)}</div>`).join(''); wrap.scrollTop = wrap.scrollHeight; }

// simple escape to avoid accidental HTML injection in logs
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;" })[c]); }
function animateAttack(fromSide,toSide,elName,onHit){ const c=$('#fxCanvas'); const rFrom=fromSide.querySelector('.card').getBoundingClientRect(); const rTo=toSide.querySelector('.card').getBoundingClientRect(); const rCan=c.getBoundingClientRect(); const start={x:(rFrom.right - rCan.left)-40,y:(rFrom.top + rFrom.height*0.35 - rCan.top)}; const end={x:(rTo.left - rCan.left)+40,y:(rTo.top + rTo.height*0.35 - rCan.top)}; runProjectile(c,start,end,EL_COLOR[elName]||'#67d4ff',onHit); }
function runProjectile(canvas,start,end,color,onHit){ const ctx=canvas.getContext('2d'); let t=0,T=320; const sx=start.x,sy=start.y,ex=end.x,ey=end.y; const raf=()=>{ t+=16; ctx.clearRect(0,0,canvas.width,canvas.height); const p=Math.min(1,t/T); const x=sx+(ex-sx)*p; const y=sy+(ey-sy)*p + Math.sin(p*Math.PI)*-12; ctx.globalAlpha=.3; ctx.fillStyle=color; for(let i=0;i<6;i++){ const tt=Math.max(0,p - i*0.04); const xx=sx+(ex-sx)*tt; const yy=sy + (ey-sy)*tt + Math.sin(tt*Math.PI)*-12; ctx.beginPath(); ctx.arc(xx,yy,3-i*0.35,0,Math.PI*2); ctx.fill(); } ctx.globalAlpha=1; ctx.beginPath(); ctx.arc(x,y,6,0,Math.PI*2); ctx.fillStyle=color; ctx.fill(); if(p<1){ requestAnimationFrame(raf);} else { burst(canvas,end,color,onHit);} }; requestAnimationFrame(raf); }
function burst(canvas,pos,color,onDone){ const ctx=canvas.getContext('2d'); let t=0,T=220; const parts=Array.from({length:14}).map(()=>({x:pos.x,y:pos.y,vx:(Math.random()*2-1)*2.2,vy:(Math.random()*2-1)*2.2,r:2+Math.random()*2})); const raf=()=>{ t+=16; const p=Math.min(1,t/T); ctx.clearRect(0,0,canvas.width,canvas.height); for(const pt of parts){ pt.x+=pt.vx; pt.y+=pt.vy; pt.vy+=.03; ctx.beginPath(); ctx.arc(pt.x, pt.y, pt.r*(1-p), 0, Math.PI*2); ctx.fillStyle=color; ctx.globalAlpha=1-p; ctx.fill(); } if(p<1){ requestAnimationFrame(raf);} else { ctx.clearRect(0,0,canvas.width, canvas.height); onDone&&onDone(); } }; requestAnimationFrame(raf); }
function byId(arr,id){ return arr.find(x=>x.id===id); }
function pickRandomDistinct(arr,n){ const pool=arr.slice(); const out=[]; while(out.length<n && pool.length){ const i=Math.floor(Math.random()*pool.length); out.push(pool.splice(i,1)[0]); } return out; }

/* åˆæœŸ */
renderPickScreen(); setScreen('start');
</script>
</body>
</html>
